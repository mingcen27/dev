<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Sarana Promosi</title>
    <!-- Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF untuk mengunduh canvas sebagai file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Inter untuk tampilan yang bersih dan modern -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar untuk estetika yang lebih baik */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        #promoCanvas {
            /* Mempertahankan rasio aspek A4 untuk pratinjau */
            aspect-ratio: 210 / 297;
        }
        /* Kelas untuk memastikan font di canvas dimuat */
        .font-inter { font-family: 'Inter'; }
        .font-tahoma { font-family: 'Tahoma'; }
        .font-arial { font-family: 'Arial'; }
        .font-roboto { font-family: 'Roboto'; }
        .font-lato { font-family: 'Lato'; }
        .font-montserrat { font-family: 'Montserrat'; }
        .font-open-sans { font-family: 'Open Sans'; }
        .font-source-sans { font-family: 'Source Sans 3'; }
        .font-georgia { font-family: 'Georgia'; }
        .font-poppins { font-family: 'Poppins'; }

        /* Responsif layout */
        @media (max-width: 1024px) {
            .lg\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Grid Konten Utama -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Kolom Input Data -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 overflow-y-auto max-h-[85vh]">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">Editor Data Promosi</h2>
                
                <!-- Info Umum -->
                <div class="space-y-4 mb-8">
                    <div>
                        <label for="promoPeriod" class="block text-sm font-medium text-gray-700 mb-1">Teks Periode Promosi</label>
                        <input type="text" id="promoPeriod" value="Periode : 1 - 31 Oktober" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="fontSelector" class="block text-sm font-medium text-gray-700 mb-1">Pilih Font</label>
                        <select id="fontSelector" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="Inter">Inter</option>
                            <option value="Tahoma">Tahoma</option>
                            <option value="Arial">Arial</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Lato">Lato</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Source Sans 3">Source Sans 3</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Poppins">Poppins</option>
                        </select>
                    </div>
                    <!-- Dropdown baru untuk penempatan periode promosi -->
                    <div>
                        <label for="promoPeriodPlacement" class="block text-sm font-medium text-gray-700 mb-1">Penempatan Periode Promosi</label>
                        <select id="promoPeriodPlacement" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="bawah">Di Bawah</option>
                            <option value="setiap_kartu">Di Setiap Kartu</option>
                            <option value="nonaktifkan">Nonaktifkan</option>
                        </select>
                    </div>
                </div>

                <!-- Daftar Produk -->
                <div id="productList" class="space-y-6">
                    <h3 class="text-xl font-bold border-b pb-2">Daftar Produk</h3>
                    <!-- Produk akan ditambahkan di sini oleh JavaScript -->
                    <button id="addProductBtn" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Tambah Produk
                    </button>
                </div>
            </div>

            <!-- Kolom Hasil Gambar -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">Hasil Gambar</h2>
                <div class="bg-gray-200 rounded-lg p-4 flex justify-center items-center">
                    <canvas id="promoCanvas" class="bg-white rounded-md shadow-inner max-w-full h-auto"></canvas>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 ease-in-out flex items-center justify-center shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                        Buat Gambar Promosi
                    </button>
                    <button id="downloadBtn" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition-all duration-300 ease-in-out flex items-center justify-center shadow-md hover:shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Unduh PDF (A4)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Elemen DOM ---
            const productList = document.getElementById('productList');
            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const addProductBtn = document.getElementById('addProductBtn');
            const canvas = document.getElementById('promoCanvas');
            const ctx = canvas.getContext('2d');
            const fontSelector = document.getElementById('fontSelector');
            const promoPeriodPlacementSelector = document.getElementById('promoPeriodPlacement');
            const promoPeriodInput = document.getElementById('promoPeriod');

            let productCount = 0;

            /**
             * Menambahkan satu set input field untuk produk baru.
             */
            function addProduct(initialData = {}) {
                productCount++;
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item p-4 border rounded-lg bg-gray-50 relative';
                productDiv.id = `product-${productCount}`;
                productDiv.innerHTML = `
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition" onclick="removeProduct(${productCount})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <h4 class="font-bold mb-3 text-gray-600">Produk ${productCount}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                            <input type="text" placeholder="e.g., TOP" value="${initialData.nama || ''}" class="data-nama w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <input type="text" placeholder="e.g., Gula 10X3" value="${initialData.deskripsi || ''}" class="data-deskripsi w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Harga Coret</label>
                            <input type="text" placeholder="e.g., 12.000" value="${initialData.coret || ''}" class="data-coret w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Harga Promo</label>
                            <input type="text" placeholder="e.g., 10.500" value="${initialData.promo || ''}" class="data-promo w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-1">Keterangan Tambahan</label>
                        <input type="text" placeholder="e.g., /3PCS atau GRATIS 1" value="${initialData.extra || ''}" class="data-extra w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                `;
                productList.insertBefore(productDiv, addProductBtn);
            }

            /**
             * Menghapus field produk.
             * @param {number} id - ID produk yang akan dihapus.
             */
            window.removeProduct = function(id) {
                const productToRemove = document.getElementById(`product-${id}`);
                if (productToRemove) {
                    productToRemove.remove();
                    // Generate ulang canvas setelah produk dihapus
                    generatePromotion();
                }
            }
            
            /**
             * Menggambar teks dengan wrapping jika terlalu panjang.
             * @param {CanvasRenderingContext2D} context - Konteks canvas.
             * @param {string} text - Teks yang akan digambar.
             * @param {number} x - Koordinat X.
             * @param {number} y - Koordinat Y.
             * @param {number} maxWidth - Lebar maksimum teks.
             * @param {number} lineHeight - Tinggi baris.
             */
            function wrapText(context, text, x, y, maxWidth, lineHeight) {
                const words = text.split(' ');
                let line = '';
                let currentY = y;
                for(let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = context.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && n > 0) {
                        context.fillText(line, x, currentY);
                        line = words[n] + ' ';
                        currentY += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                context.fillText(line, x, currentY);
            }

            /**
             * Fungsi utama untuk menggambar promosi ke canvas.
             */
            function generatePromotion() {
                // Konfigurasi Canvas untuk kualitas tinggi dengan rasio A4
                const printDPI = 300;
                const mmPerInch = 25.4;
                const canvasWidth = (210 / mmPerInch) * printDPI;
                const canvasHeight = (297 / mmPerInch) * printDPI;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                // Reset canvas
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                
                const selectedFont = fontSelector.value;
                const promoPeriodText = promoPeriodInput.value;
                const periodPlacement = promoPeriodPlacementSelector.value;
                const canvasPadding = 50; 
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 10;
                
                // Gambar border luar
                ctx.strokeRect(
                    ctx.lineWidth / 2 + canvasPadding, 
                    ctx.lineWidth / 2 + canvasPadding, 
                    canvasWidth - ctx.lineWidth - (2 * canvasPadding), 
                    canvasHeight - ctx.lineWidth - (2 * canvasPadding)
                );
                
                // Ambil data produk dari semua field
                const productElements = document.querySelectorAll('.product-item');
                const products = [];
                
                productElements.forEach(p => {
                    products.push({
                        nama: p.querySelector('.data-nama').value.toUpperCase(),
                        deskripsi: p.querySelector('.data-deskripsi').value,
                        hargaCoret: p.querySelector('.data-coret').value,
                        hargaPromo: p.querySelector('.data-promo').value,
                        extra: p.querySelector('.data-extra').value
                    });
                });
                
                if (products.length === 0) {
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.font = `400 70px '${selectedFont}'`;
                    ctx.fillText("Tambahkan produk untuk dibuatkan promosi.", canvasWidth / 2, canvasHeight / 2);
                    downloadBtn.disabled = true;
                    return;
                }

                // Konfigurasi Grid
                const numProducts = products.length;
                const cols = numProducts > 3 ? 2 : 1;
                const rows = Math.ceil(numProducts / cols);
                const topMargin = 52;
                const bottomMargin = (periodPlacement === 'bawah' || periodPlacement === 'nonaktifkan') ? 250 : 50;
                const gridWidth = canvasWidth - (2 * canvasPadding) - (ctx.lineWidth);
                const gridHeight = canvasHeight - topMargin - bottomMargin;
                const cellWidth = gridWidth / cols;
                const cellHeight = gridHeight / rows;
                
                // Gambar Garis Grid
                ctx.beginPath();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 10;
                // Garis vertikal
                if (cols > 1) {
                    ctx.moveTo(canvasPadding + ctx.lineWidth / 2 + cellWidth, topMargin);
                    ctx.lineTo(canvasPadding + ctx.lineWidth / 2 + cellWidth, topMargin + (cellHeight * rows));
                }
                // Garis horizontal dan garis tepi atas/bawah grid
                for (let i = 0; i <= rows; i++) {
                    ctx.moveTo(canvasPadding + ctx.lineWidth / 2, topMargin + (cellHeight * i));
                    ctx.lineTo(canvasWidth - canvasPadding - ctx.lineWidth / 2, topMargin + (cellHeight * i));
                }
                ctx.stroke();
                
                // Gambar setiap produk di dalam selnya
                products.forEach((product, i) => {
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    
                    const startX = canvasPadding + ctx.lineWidth / 2 + (col * cellWidth);
                    const startY = topMargin + (row * cellHeight);
                    
                    const centerX = startX + cellWidth / 2;
                    let currentY = startY + cellHeight * 0.15; // Adjusted start position for the new title

                    // NEW: Draw "PROMO SPESIAL" title
                    ctx.font = `900 80px '${selectedFont}'`;
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.fillText("PROMO SPESIAL", centerX, currentY);
                    currentY += 150; // Add some space

                    // Nama Produk
                    ctx.font = `900 120px '${selectedFont}'`;
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    wrapText(ctx, product.nama, centerX, currentY, cellWidth * 0.9, 100);
                    currentY += 100;

                    // Deskripsi
                    ctx.font = `600 70px '${selectedFont}'`;
                    ctx.fillStyle = 'black';
                    wrapText(ctx, product.deskripsi, centerX, currentY, cellWidth * 0.8, 95);
                    currentY += 250;
                    
                    // Harga Coret
                    if (product.hargaCoret) {
                        ctx.font = `900 100px '${selectedFont}'`;
                        ctx.fillStyle = '#000'; // Warna abu-abu
                        const coretText = `Rp. ${product.hargaCoret}`;
                        const textMetrics = ctx.measureText(coretText);
                        ctx.fillText(coretText, centerX, currentY);
                    
                        // Gambar garis coret manual
                        ctx.beginPath();
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 15;
                        ctx.moveTo(centerX - textMetrics.width / 2, currentY - 0);
                        ctx.lineTo(centerX + textMetrics.width / 2, currentY - 50);
                        ctx.stroke();
                        ctx.lineWidth = 15; // Reset line width
                        ctx.strokeStyle = 'black';
                        currentY += 190;
                    }

                    // Harga Promo
                    ctx.font = `900 180px '${selectedFont}'`;
                    ctx.fillStyle = '#000'; // Warna merah untuk harga promo
                    ctx.fillText(product.hargaPromo, centerX, currentY);
                    currentY += 200;


                    // Keterangan Tambahan
                    if (product.extra) {
                        ctx.font = `900 80px '${selectedFont}'`;
                        ctx.fillStyle = 'black';
                        ctx.textAlign = 'right';
                        
                        const textX = startX + cellWidth - 60;
                        const textY = startY + cellHeight - 140; // Adjusted for upward shift
                        const maxWidth = cellWidth * 1;
                        const lineHeight = 50;
                        
                        wrapText(ctx, product.extra, textX, textY, maxWidth, lineHeight);
                    }

                    // Logika baru untuk pita dan periode promosi
                    if (periodPlacement === 'setiap_kartu') {
                        // Gambar pita di bagian bawah setiap kartu
                        const ribbonHeight = 70;
                        const marginTop = 10; // Define a margin from the bottom of the card
                        const ribbonY = startY + cellHeight - ribbonHeight - marginTop;
                        
                        ctx.fillStyle = 'black';
                        ctx.beginPath();
                        ctx.moveTo(startX, ribbonY); // Kiri bawah
                        ctx.lineTo(startX + cellWidth, ribbonY); // Kanan bawah
                        ctx.lineTo(startX + cellWidth, startY + cellHeight); // Kanan atas
                        ctx.lineTo(startX, startY + cellHeight); // Kiri atas
                        ctx.closePath();
                        ctx.fill();

                        // Gambar teks periode di atas pita
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.font = `800 55px '${selectedFont}'`;
                        ctx.fillText(promoPeriodText, centerX, ribbonY + ribbonHeight * 0.9);
                    }
                });

                // Gambar periode promosi di bagian bawah, hanya jika opsi 'bawah' dipilih
                if (periodPlacement === 'bawah') {
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.font = `800 80px '${selectedFont}'`;
                    ctx.fillText(promoPeriodText, canvasWidth / 2, canvasHeight - 120);
                }

                // Aktifkan tombol unduh
                downloadBtn.disabled = false;
            }

            // --- Event Listeners ---
            generateBtn.addEventListener('click', generatePromotion);
            addProductBtn.addEventListener('click', () => addProduct());
            
            downloadBtn.addEventListener('click', function () {
                if (this.disabled) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgData = canvas.toDataURL('image/png', 1.0);
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();

                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                doc.save('promo-gantung-a4.pdf');
            });
            
            fontSelector.addEventListener('change', generatePromotion);
            promoPeriodPlacementSelector.addEventListener('change', generatePromotion);
            promoPeriodInput.addEventListener('input', generatePromotion);

            // --- Inisialisasi ---
            // Tambahkan 6 produk awal sebagai contoh
            const sampleData = [
                { nama: 'TOP', deskripsi: 'Gula 10X3', coret: '25.700', promo: 'BELI 3', extra: 'GRATIS 1' },
                { nama: 'ULTRA', deskripsi: 'TEH KOTAK JASMIN TP 300ml', coret: '12.000', promo: '10.500', extra: '/3PCS' },
                { nama: 'BONEETO', deskripsi: 'CHOCLATE BOX 685G', coret: '78.900', promo: '64.900', extra: '' },
                { nama: 'LUWAK', deskripsi: 'WHT KOFFIE 9+1x20G', coret: '15.900', promo: '13.500', extra: '' },
                { nama: 'KOPI KAPAL API', deskripsi: 'Special Mix 10x25g', coret: '20.000', promo: '18.500', extra: 'GRATIS MUG' },
                { nama: 'INDOMIE', deskripsi: 'Rasa Ayam Bawang', coret: '3.500', promo: '2.800', extra: '' }
            ];
            
            sampleData.forEach(data => addProduct(data));
            
            // Generate gambar awal saat halaman dimuat
            generatePromotion();
        });
    </script>
</body>
</html>
